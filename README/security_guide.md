# ๐ ุฏููู ุงูุฃูุงู ูุงูุญูุงูุฉ - Security Guide

## ูุธุฑุฉ ุนุงูุฉ

ูุธุงู ุญูุงูุฉ ุดุงูู ูุชุนุฏุฏ ุงูุทุจูุงุช ูุญูู:
- โ API ุงูุฎุงุต ุจูุง ูู ุงูุฅุณุงุกุฉ ูุงููุฌูุงุช
- โ OpenAI API ูู ุงูุงุณุชุฎุฏุงู ุงูููุฑุท
- โ ุงูุฎุงุฏู ูู ุงูุญูู ุงูุฒุงุฆุฏ
- โ ุงูุจูุงูุงุช ูู ุงููุญุชูู ุงูุถุงุฑ

---

## ๐ก๏ธ ุทุจูุงุช ุงูุญูุงูุฉ

### 1. Rate Limiting - ุชุญุฏูุฏ ูุนุฏู ุงูุทูุจุงุช

**ุงููุธููุฉ:** ููุน ุฅุฑุณุงู ุทูุจุงุช ูุซูุฑุฉ ูู ููุช ูุตูุฑ

**ุงูุญุฏูุฏ:**
- 20 ุทูุจ ูู ุงูุฏูููุฉ ููู IP
- ุญุธุฑ ููุฏุฉ 15 ุฏูููุฉ ุนูุฏ ุงูุชุฌุงูุฒ
- ุฅุนุงุฏุฉ ุชุนููู ุงูุนุฏุงุฏ ูู ุฏูููุฉ

**ุงูุชุทุจูู:**
```python
# ูู SecurityMiddleware
is_limited, reason = rate_limiter.is_rate_limited(
    identifier=client_ip,
    max_requests=20,
    window_seconds=60,
    block_duration_minutes=15
)
```

**ุงูุงุณุชุฌุงุจุฉ ุนูุฏ ุงูุชุฌุงูุฒ:**
```json
{
  "error": "Too Many Requests",
  "message": "ุชุฌุงูุฒุช ุงูุญุฏ ุงููุณููุญ (20 ุทูุจุงุช/60 ุซุงููุฉ)",
  "retry_after": 900
}
```

**HTTP Status Code:** 429 Too Many Requests

---

### 2. Input Validation - ุงูุชุญูู ูู ุงููุฏุฎูุงุช

**ุงููุธููุฉ:** ููุน ุงูุจูุงูุงุช ุงูุถุงุฑุฉ ุฃู ุบูุฑ ุงูุตุญูุญุฉ

**ุงูุชุญููุงุช:**

#### ุญุฌู ุงููุต:
- **ุงูุญุฏ ุงูุฃุฏูู:** 50 ุญุฑู
- **ุงูุญุฏ ุงูุฃูุตู:** 50,000 ุญุฑู
- **ุงุณู ุงููุชุฌุฑ:** 2-200 ุญุฑู
- **ุงูุชุฎุตุต:** 2-200 ุญุฑู

#### ุงูุฃููุงุท ุงููุดุจููุฉ:
```python
SUSPICIOUS_PATTERNS = [
    'javascript:',
    '<script',
    'onerror=',
    'onclick=',
    'eval(',
    'exec(',
    '__import__',
    'os.system',
    'subprocess',
]
```

#### ุงูุฃุญุฑู ุงูุฎุทุฑุฉ:
```python
suspicious_chars = ['<', '>', '{', '}', '[', ']', '\\', '|']
```

**ูุซุงู ุนูู ุฑุณุงูุฉ ุฎุทุฃ:**
```
"ูุต ุงูุณูุงุณุฉ ูุญุชูู ุนูู ูุญุชูู ูุดุจูู: javascript:"
```

---

### 3. Content Filtering - ุชุตููุฉ ุงููุญุชูู

**ุงููุธููุฉ:** ููุน ุงููุญุชูู ุบูุฑ ุงูููุงุณุจ

#### ูุญุต ุงููููุงุช ุงููุญุธูุฑุฉ:
```python
BLOCKED_WORDS = ['spam', 'hack', 'crack', 'exploit']
```

#### ูุญุต ุงูุชูุฑุงุฑ ุงูููุฑุท:
- ููุชุดู ุชูุฑุงุฑ ููุณ ุงููููุฉ ุฃูุซุฑ ูู 30% ูู ุงููุต
- ูููุน spam ูุงููุตูุต ุงูุนุดูุงุฆูุฉ

**ูุซุงู:**
```
ุงููุต: "test test test test test..."
ุงููุชูุฌุฉ: โ "ุชูุฑุงุฑ ููุฑุท ุชู ุงูุชุดุงูู"
```

---

### 4. Request Size Limiting - ุชุญุฏูุฏ ุญุฌู ุงูุทูุจ

**ุงููุธููุฉ:** ููุน ุงูุทูุจุงุช ุงููุจูุฑุฉ ุฌุฏุงู

**ุงูุญุฏ ุงูุฃูุตู:** 10 MB

**ุงูุชุทุจูู:**
```python
app.add_middleware(RequestSizeMiddleware, max_request_size=10 * 1024 * 1024)
```

**HTTP Status Code:** 413 Payload Too Large

---

### 5. Request Deduplication - ููุน ุงูุทูุจุงุช ุงูููุฑุฑุฉ

**ุงููุธููุฉ:** ููุน ูุนุงูุฌุฉ ููุณ ุงูุทูุจ ูุฑุชูู

**ุงูุขููุฉ:**
- ุฅูุดุงุก SHA256 hash ููุทูุจ
- ุชุฎุฒูู hash ููุฏุฉ 5 ุฏูุงุฆู
- ุฑูุถ ุงูุทูุจุงุช ุงูููุฑุฑุฉ

**ูุซุงู:**
```python
request_hash = hashlib.sha256(request_data).hexdigest()
if is_duplicate(request_hash):
    return "ุทูุจ ููุฑุฑ. ุชู ูุนุงูุฌุฉ ูุฐุง ุงูุทูุจ ูุคุฎุฑุงู"
```

---

### 6. OpenAI API Safeguards - ุญูุงูุฉ OpenAI

#### ุฃ) Daily Limits - ุญุฏูุฏ ููููุฉ:
```python
max_daily_requests = 1000      # 1000 ุทูุจ ููููุงู
max_daily_tokens = 1,000,000   # 1M token ููููุงู
```

#### ุจ) Token Limits - ุญุฏูุฏ ุงูู tokens:
```python
max_prompt_tokens = 8000       # ุญุฏ ุฃูุตู ููู prompt
max_tokens_per_request = 4000  # ุญุฏ ุฃูุตู ููุงุณุชุฌุงุจุฉ
```

#### ุฌ) Retry Mechanism - ุฅุนุงุฏุฉ ุงููุญุงููุฉ:
```python
max_retries = 3
retry_delay = 2  # seconds
```

**ุงูุงุณุชุฑุงุชูุฌูุฉ:**
- ุฅุนุงุฏุฉ ุงููุญุงููุฉ ููุท ููุฃุฎุทุงุก ุงููุคูุชุฉ
- ุฒูุงุฏุฉ ุงูุชุฃุฎูุฑ ูุน ูู ูุญุงููุฉ (2s, 4s, 6s)
- ุนุฏู ุฅุนุงุฏุฉ ุงููุญุงููุฉ ููุฃุฎุทุงุก ุงูุฏุงุฆูุฉ

#### ุฏ) Timeout Protection - ุญูุงูุฉ ูู ุงูุชุนููู:
```python
timeout = 120  # 2 minutes
```

**HTTP Status Code:** 504 Gateway Timeout

#### ูู) Circuit Breaker - ูุงุทุน ุงูุฏุงุฆุฑุฉ:
```python
failure_threshold = 5         # 5 ูุดู ูุชุชุงูู
recovery_timeout = 120        # 2 minutes
```

**ุงูุญุงูุงุช:**
- **Closed:** ุนุงุฏูุ ุงูุงุณุชุฏุนุงุกุงุช ุชุนูู
- **Open:** ุงูุฎุฏูุฉ ูุนุทูุฉุ ุฑูุถ ุฌููุน ุงูุทูุจุงุช
- **Half-Open:** ูุญุงููุฉ ุงูุงุชุตุงู ูุฑุฉ ุฃุฎุฑู

**ูุซุงู:**
```
ุจุนุฏ 5 ูุดู ูุชุชุงูู โ Open
ุงูุชุธุงุฑ 2 ุฏูููุฉ โ Half-Open
ูุญุงููุฉ ูุงุญุฏุฉ ูุงุฌุญุฉ โ Closed
```

---

## ๐ Security Headers

ุชูุถุงู ุชููุงุฆูุงู ููู ุงุณุชุฌุงุจุฉ:

```python
{
    "X-Content-Type-Options": "nosniff",
    "X-Frame-Options": "DENY",
    "X-XSS-Protection": "1; mode=block",
    "Strict-Transport-Security": "max-age=31536000",
    "X-Process-Time": "1.23"
}
```

---

## ๐ ุฃูุซูุฉ ุนูู ุงูุณููุงุฑูููุงุช

### ุณููุงุฑูู 1: ูุฌูู DDoS
```
ุงูููุงุฌู: ูุฑุณู 100 ุทูุจ ูู ุซุงููุฉ ูุงุญุฏุฉ
ุงููุธุงู:
  - ููุจู ุฃูู 20 ุทูุจ
  - ูุฑูุถ ุงูุจุงูู ุจู 429
  - ูุญุธุฑ IP ููุฏุฉ 15 ุฏูููุฉ
  - ูุณุฌู ุงูุญุงุฏุซุฉ ูู logs
```

### ุณููุงุฑูู 2: ูุญุงููุฉ ุญูู ููุฏ
```
ุงููุณุชุฎุฏู: ูุฑุณู ูุต ูุญุชูู ุนูู <script>alert('xss')</script>
ุงููุธุงู:
  - ููุชุดู ุงูููุท ุงููุดุจูู
  - ูุฑูุถ ุงูุทูุจ ุจู 400
  - ูุณุฌู ุงููุญุงููุฉ
  - ุงูุฑุณุงูุฉ: "ูุต ุงูุณูุงุณุฉ ูุญุชูู ุนูู ูุญุชูู ูุดุจูู"
```

### ุณููุงุฑูู 3: ูุต ุทููู ุฌุฏุงู
```
ุงููุณุชุฎุฏู: ูุฑุณู ูุต 100,000 ุญุฑู
ุงููุธุงู:
  - ููุญุต ุงูุทูู
  - ูุฑูุถ ุงูุทูุจ ุจู 400
  - ุงูุฑุณุงูุฉ: "ูุต ุงูุณูุงุณุฉ ุทููู ุฌุฏุงู. ุงูุญุฏ ุงูุฃูุตู 50,000 ุญุฑู"
```

### ุณููุงุฑูู 4: OpenAI timeout
```
OpenAI: ูุชุฃุฎุฑ ูู ุงูุฑุฏ ุฃูุซุฑ ูู 2 ุฏูููุฉ
ุงููุธุงู:
  - ููุชุธุฑ 120 ุซุงููุฉ
  - ููุบู ุงูุทูุจ
  - ูุนูุฏ ุงููุญุงููุฉ (ูุฑุชูู ุฃุฎุฑู)
  - ุฅุฐุง ูุดู: ูุฑุฌุน 504
  - ุงูุฑุณุงูุฉ: "ุงูุชูุช ูููุฉ ุงูุงุณุชุฌุงุจุฉ"
```

### ุณููุงุฑูู 5: ุชุฌุงูุฒ ุงูุญุฏ ุงููููู
```
ุงููุณุชุฎุฏู: ุฃุฑุณู 1001 ุทูุจ ูู ููู ูุงุญุฏ
ุงููุธุงู:
  - ููุญุต ุงูุนุฏุงุฏ ุงููููู
  - ูุฑูุถ ุงูุทูุจ ุจู 429
  - ุงูุฑุณุงูุฉ: "ุชู ุชุฌุงูุฒ ุงูุญุฏ ุงููููู ููุทูุจุงุช (1000)"
```

---

## ๐๏ธ ุงูุชูููู ูุงูุฅุนุฏุงุฏุงุช

### ุชุบููุฑ ุญุฏูุฏ Rate Limiting

ูู `main.py` ุฃู `middleware.py`:
```python
is_limited = rate_limiter.is_rate_limited(
    identifier=client_ip,
    max_requests=50,          # ุฒูุงุฏุฉ ุฅูู 50 ุทูุจ
    window_seconds=120,       # ูู 2 ุฏูููุฉ
    block_duration_minutes=30 # ุญุธุฑ ููุฏุฉ 30 ุฏูููุฉ
)
```

### ุชุบููุฑ ุญุฏูุฏ OpenAI

ูู `safeguards.py`:
```python
class OpenAISafeguard:
    def __init__(self):
        self.max_retries = 5              # 5 ูุญุงููุงุช
        self.retry_delay = 3              # 3 ุซูุงูู
        self.timeout = 180                # 3 ุฏูุงุฆู
        self.max_tokens_per_request = 6000
        self.max_prompt_tokens = 12000
```

### ุชุบููุฑ ุญุฌู ุงูุทูุจ ุงูุฃูุตู

ูู `main.py`:
```python
app.add_middleware(
    RequestSizeMiddleware,
    max_request_size=20 * 1024 * 1024  # 20 MB
)
```

### ุฅุถุงูุฉ ูููุงุช ูุญุธูุฑุฉ

ูู `safeguards.py`:
```python
BLOCKED_WORDS = [
    'spam', 'hack', 'crack', 'exploit',
    'custom_word1', 'custom_word2'
]
```

---

## ๐ ุงููุฑุงูุจุฉ ูุงูุชุญููู

### ูุญุต Rate Limiting
```python
# ุนุฏุฏ ุงูุทูุจุงุช ุงููุชุจููุฉ
remaining = rate_limiter.get_remaining_requests(ip_address)
print(f"Remaining: {remaining}/20")
```

### ูุญุต ุงุณุชููุงู OpenAI
```python
# ุงูุงุณุชููุงู ุงููููู
today = datetime.now().date()
print(f"Requests today: {openai_safeguard.daily_requests[today]}")
print(f"Tokens today: {openai_safeguard.daily_tokens[today]}")
```

### Logs ุงูุฃูููุฉ
ุฌููุน ุงูุฃุญุฏุงุซ ุงูุฃูููุฉ ุชูุณุฌู ูู:
```
logs/app.log
logs/errors/
```

ูุซุงู:
```
2024-12-14 15:30:45 - WARNING - ๐ซ Rate limit exceeded: 192.168.1.100
2024-12-14 15:31:00 - WARNING - โ๏ธ Validation error: ูุญุชูู ูุดุจูู
2024-12-14 15:32:15 - ERROR - โ Daily limit exceeded
```

---

## โก Best Practices

### 1. ูููุทูุฑูู

โ **ุงูุนู:**
- ุงุณุชุฎุฏู HTTPS ูู Production
- ุฑุงูุจ Logs ุจุงูุชุธุงู
- ุญุฏูุซ ุงูุญุฏูุฏ ุญุณุจ ุงูุญุงุฌุฉ
- ุงุฎุชุจุฑ ุงูุฃูุงู ุจุงูุชุธุงู

โ **ูุง ุชูุนู:**
- ูุง ุชุนุทูู ุงูุญูุงูุฉ ูู Production
- ูุง ุชุฒูุฏ ุงูุญุฏูุฏ ุจุดูู ููุฑุท
- ูุง ุชุชุฌุงูู ุงูุชุญุฐูุฑุงุช ุงูุฃูููุฉ

### 2. ูููุณุชุฎุฏููู

โ **ุงูุนู:**
- ุงุญุชุฑู ุญุฏูุฏ ุงูุงุณุชุฎุฏุงู
- ูุง ุชุฑุณู ุทูุจุงุช ูุชูุฑุฑุฉ
- ุงุณุชุฎุฏู ูุตูุต ูุนูููุฉ ุงูุทูู

โ **ูุง ุชูุนู:**
- ูุญุงููุฉ ุชุฎุทู ุงูุญูุงูุฉ
- ุฅุฑุณุงู ูุญุชูู ุถุงุฑ
- ุงุณุชุฎุฏุงู ุฃุฏูุงุช ุฃุชูุชุฉ ููุฑุทุฉ

---

## ๐จ ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก

### Error Codes

| Code | ุงููุนูู | ุงูุณุจุจ | ุงูุญู |
|------|--------|-------|------|
| 400  | Bad Request | ุจูุงูุงุช ุบูุฑ ุตุญูุญุฉ | ุชุญูู ูู ุงููุฏุฎูุงุช |
| 413  | Payload Too Large | ุทูุจ ูุจูุฑ ุฌุฏุงู | ููู ุญุฌู ุงูุจูุงูุงุช |
| 429  | Too Many Requests | ุชุฌุงูุฒ ุงูุญุฏ | ุงูุชุธุฑ ูุญุงูู ูุฑุฉ ุฃุฎุฑู |
| 503  | Service Unavailable | ุงูุฎุฏูุฉ ูุนุทูุฉ | ุงูุชุธุฑ ุฏูุงุฆู ูุญุงูู |
| 504  | Gateway Timeout | ุงุณุชุฌุงุจุฉ ุจุทูุฆุฉ | ุญุงูู ูุฑุฉ ุฃุฎุฑู |

### ุฃูุซูุฉ ุนูู ุฑุณุงุฆู ุงูุฃุฎุทุงุก

#### 400 - Validation Error
```json
{
  "error": "Validation Error",
  "message": "ูุต ุงูุณูุงุณุฉ ูุญุชูู ุนูู ูุญุชูู ูุดุจูู: <script"
}
```

#### 429 - Rate Limit
```json
{
  "error": "Too Many Requests",
  "message": "ุชุฌุงูุฒุช ุงูุญุฏ ุงููุณููุญ (20 ุทูุจุงุช/60 ุซุงููุฉ). ุชู ุญุธุฑู ููุฏุฉ 15 ุฏูููุฉ",
  "retry_after": 900
}
```

#### 503 - Circuit Breaker
```json
{
  "error": "Service Unavailable",
  "message": "ุงูุฎุฏูุฉ ูุนุทูุฉ ูุคูุชุงู. ุงูุฑุฌุงุก ุงููุญุงููุฉ ูุงุญูุงู"
}
```

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ Rate Limiting
```bash
# ุฅุฑุณุงู 25 ุทูุจ ูุชุชุงูู
for i in {1..25}; do
  curl -X POST "http://localhost:8000/api/analyze" \
    -H "Content-Type: application/json" \
    -d @test_data.json
  echo "Request $i"
done
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- ุฃูู 20 ุทูุจ: 200 OK
- ุงูุทูุจุงุช 21-25: 429 Too Many Requests

### ุงุฎุชุจุงุฑ Input Validation
```bash
# ูุญุงููุฉ ุญูู ููุฏ
curl -X POST "http://localhost:8000/api/analyze" \
  -H "Content-Type: application/json" \
  -d '{
    "shop_name": "Test",
    "shop_specialization": "Test",
    "policy_type": "ุณูุงุณุงุช ุงูุงุณุชุฑุฌุงุน ู ุงูุงุณุชุจุฏุงู",
    "policy_text": "<script>alert('xss')</script>"
  }'
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:** 400 Bad Request

---

## ๐ ูุงุฆูุฉ ุงูุชุญูู ุงูุฃูููุฉ

ูุจู ุงููุดุฑ ูู Production:

- [ ] ุชู ุชูุนูู HTTPS
- [ ] ุชู ุชุญุฏูุซ ููุงุชูุญ API
- [ ] ุชู ุถุจุท ุญุฏูุฏ ููุงุณุจุฉ ููุฅูุชุงุฌ
- [ ] ุชู ุงุฎุชุจุงุฑ ุฌููุน ุงูุณููุงุฑูููุงุช
- [ ] ุชู ุฅุนุฏุงุฏ ุงููุฑุงูุจุฉ ูุงูุชูุจููุงุช
- [ ] ุชู ูุฑุงุฌุนุฉ Logs
- [ ] ุชู ุชูุนูู ุฌููุน Middleware
- [ ] ุชู ุงุฎุชุจุงุฑ ุงูุญูู (Load Testing)
- [ ] ุชู ุชูุซูู ุงูุฅุนุฏุงุฏุงุช
- [ ] ุชู ุชุฏุฑูุจ ุงููุฑูู

---

## ๐ฏ ููุฎุต

ุงููุธุงู ูุญูู ุจู:
- โ Rate Limiting (20 req/min)
- โ Input Validation (50-50K chars)
- โ Content Filtering
- โ Request Size Limiting (10 MB)
- โ Deduplication (5 min)
- โ OpenAI Safeguards (1000 req/day)
- โ Circuit Breaker
- โ Timeout Protection (2 min)
- โ Retry Mechanism (3 attempts)
- โ Security Headers
- โ Complete Logging

**ุงููุชูุฌุฉ:** API ุขูู ูููุซูู ููุญูู ูู ุฌููุน ุฃููุงุน ุงูุฅุณุงุกุฉ! ๐
