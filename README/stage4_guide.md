# ๐ Stage 4: Policy Regeneration - ุฏููู ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ

## ูุธุฑุฉ ุนุงูุฉ

ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ ูู ูุฑุญูุฉ **ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุณูุงุณุฉ** ุจูุณุฎุฉ ูุญุณููุฉ ุชุทุจู ุฌููุน ุงูุงูุชุฑุงุญุงุช ูุงูุชูุตูุงุช ูุชุญููู ุงูุชุซุงู ุฃุนูู.

---

## ๐ ูุฑุงุญู ุงูุชุญููู ุงููุงููุฉ

### Stage 1: Policy Matching โ
- ุงูุชุญูู ูู ุชุทุงุจู ููุน ุงูุณูุงุณุฉ ูุน ุงููุต

### Stage 2: Compliance Analysis โ
- ุชุญููู ุงูุงูุชุซุงู ุงููุงูููู
- ูุดู ุงููุฎุงููุงุช ูุงูููุงูุต

### Stage 3: Report Generation โ
- ุฅูุดุงุก ุชูุฑูุฑ ุดุงูู
- ููุงุฆู ุจุงููุดุงูู ูุงูุงูุชุฑุงุญุงุช

### Stage 4: Policy Regeneration โญ ุฌุฏูุฏ
- ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงูุณูุงุณุฉ ุงููุญุณููุฉ
- ุชุทุจูู ุฌููุน ุงูุงูุชุฑุงุญุงุช
- ุชุญููู ุงูุชุซุงู 95%+

---

## ๐ฏ ูุชู ุชูููุฐ ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉุ

```python
if compliance_ratio < 95%:
    # ุชูููุฐ Stage 4 ุชููุงุฆูุงู
    improved_policy = regenerate_policy(...)
else:
    # ุงูุณูุงุณุฉ ููุชุงุฒุฉ ุจุงููุนูุ ูุง ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุงููุชุงุจุฉ
    skip_stage_4()
```

**ุงูุดุฑุท:** ูุณุจุฉ ุงูุงูุชุซุงู ุฃูู ูู 95%

---

## ๐ ูุง ุชูุนูู ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ

### 1. ุชุญููู ุงููุดุงูู
```python
critical_issues = [
    "ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ ูุง ุชุฑุฏ ููุง ุชุณุชุจุฏู",
    "ูุง ููุจู ุงูุงุณุชุฑุฌุงุน ุงูููุฏู"
]

weaknesses = [
    "ุนุฏู ุชูุถูุญ ูุฏุฉ ุงูุงุณุชุฑุฌุงุน",
    "ุนุฏู ุฐูุฑ ุงุณุชุซูุงุกุงุช ุงูุฅุฑุฌุงุน"
]

missing_standards = [
    "ุณูุงุณุฉ ุงููุงุชูุฑุฉ ุงูุฅููุชุฑูููุฉ",
    "ุงูุชุนุงูู ูุน ุชุฃุฎูุฑ ุงูุชูุตูู"
]
```

### 2. ุฅุนุงุฏุฉ ุงููุชุงุจุฉ
- ุฅุตูุงุญ ุฌููุน ุงููุฎุงููุงุช
- ุฅุถุงูุฉ ุงููุนุงููุฑ ุงูููููุฏุฉ
- ุชุญุณูู ุงูุตูุงุบุฉ ูุงููุถูุญ
- ุชูุธูู ุฃูุถู

### 3. ุงูุชุฎุตูุต
- ูุฑุงุนุงุฉ ุชุฎุตุต ุงููุชุฌุฑ
- ุฅุถุงูุฉ ุงุณุชุซูุงุกุงุช ููุงุณุจุฉ
- ุฃูุซูุฉ ุฐุงุช ุตูุฉ

---

## ๐ง ุงูุชูููุฐ ุงูุชููู

### ุงููููุงุช ุงููุถุงูุฉ:

#### 1. `app/prompts/policy_generator.py`
```python
def get_policy_regeneration_prompt(
    shop_name,
    shop_specialization,
    policy_type,
    original_policy_text,
    compliance_report
):
    # ุจูุงุก prompt ุดุงูู ูุฅุนุงุฏุฉ ุงููุชุงุจุฉ
    return prompt
```

#### 2. ุชุญุฏูุซ `app/models.py`
```python
class ImprovedPolicyResult(BaseModel):
    improved_policy: str
    improvements_made: List[ImprovementDetail]
    compliance_enhancements: List[str]
    estimated_new_compliance: float
    key_additions: List[str]
    notes: Optional[str]

class ImprovementDetail(BaseModel):
    category: str
    description: str
    before: Optional[str]
    after: str
```

#### 3. ุชุญุฏูุซ `analyzer_service.py`
```python
async def _regenerate_policy(...):
    # ุงุณุชุฏุนุงุก OpenAI ูุฅุนุงุฏุฉ ุงููุชุงุจุฉ
    result = await openai_service.regenerate_policy(...)
    return ImprovedPolicyResult(...)
```

---

## ๐ ูุซุงู ุนูู ุงููุฎุฑุฌุงุช

### Input (ุงููุต ุงูุฃุตูู):
```
ุณูุงุณุฉ ุงูุฅุฑุฌุงุน:
ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ ูุง ุชุฑุฏ ููุง ุชุณุชุจุฏู.
```

**ุงููุดุงูู:**
- โ ูุฎุงููุฉ ูููุงุฏุฉ 13
- โ ูุณุจุฉ ุงูุชุซุงู: 15%

### Output (ุงููุต ุงููุญุณูู):
```
ุณูุงุณุฉ ุงูุงุณุชุฑุฌุงุน ูุงูุงุณุชุจุฏุงู

1. ุญู ุงูุงุณุชุฑุฌุงุน:
   ูุญู ููุนููู ุฅุฑุฌุงุน ุงูููุชุฌ ููุณุฎ ุงูุนูุฏ ุฎูุงู 7 ุฃูุงู ูู ุชุงุฑูุฎ 
   ุงุณุชูุงู ุงูููุชุฌ ุฏูู ุฅุจุฏุงุก ุฃุณุจุงุจ.

2. ุดุฑูุท ุงูุงุณุชุฑุฌุงุน:
   - ุฃู ูููู ุงูููุชุฌ ูู ุญุงูุชู ุงูุฃุตููุฉ
   - ูุฌูุฏ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
   - ุนุฏู ุงุณุชุฎุฏุงู ุงูููุชุฌ

3. ุงุณุชุซูุงุกุงุช ุงูุงุณุชุฑุฌุงุน:
   ูุง ููุจู ุงุณุชุฑุฌุงุน ุงูููุชุฌุงุช ุงูุชุงููุฉ:
   - ุงูููุงุจุณ ุงูุฏุงุฎููุฉ
   - ุงูุนุทูุฑ ุงูููุชูุญุฉ
   - ุงูููุชุฌุงุช ุงููุตูุนุฉ ุฎุตูุตุงู ููุนููู

4. ุฅุฌุฑุงุกุงุช ุงูุงุณุชุฑุฌุงุน:
   - ุงูุชูุงุตู ูุน ุฎุฏูุฉ ุงูุนููุงุก ุฎูุงู 7 ุฃูุงู
   - ุฅุนุงุฏุฉ ุงูููุชุฌ ุจุชุบูููู ุงูุฃุตูู
   - ุงุณุชุฑุฏุงุฏ ุงููุจูุบ ุฎูุงู 14 ููู ุนูู

5. ุชุญูู ุชูุงููู ุงูุดุญู:
   - ูุชุญูู ุงูุนููู ุชูุงููู ุงูุฅุฑุฌุงุน ุฅุฐุง ูุงู ุจุฑุบุจุชู
   - ูุชุญูู ุงููุชุฌุฑ ุงูุชูุงููู ูู ุญุงู ูุฌูุฏ ุนูุจ
```

**ุงูุชุญุณููุงุช:**
- โ ูุณุจุฉ ุงูุชุซุงู ุฌุฏูุฏุฉ: 98%
- โ ุฃุถููุช 5 ูุนุงููุฑ ููููุฏุฉ
- โ ุตูุงุบุฉ ูุงุถุญุฉ ูููุธูุฉ

---

## ๐จ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ุนุฑุถ ุงูุณูุงุณุฉ ุงููุญุณููุฉ:

```html
<div class="improved-policy-section">
    <h3>ุงูุณูุงุณุฉ ุงููุญุณููุฉ</h3>
    <span class="badge">98% ุงูุชุซุงู</span>
    
    <div class="policy-text">
        [ุงููุต ุงููุงูู ููุณูุงุณุฉ ุงููุญุณููุฉ]
    </div>
    
    <button onclick="copyPolicy()">ูุณุฎ ุงูุณูุงุณุฉ</button>
</div>
```

### ุนุฑุถ ุงูุชุญุณููุงุช:

```html
<div class="improvements-list">
    <h4>ุงูุชุญุณููุงุช ุงูููุทุจูุฉ (8)</h4>
    
    <div class="improvement-item">
        <span class="category">ุชุตุญูุญ ูุดููุฉ ุญุฑุฌุฉ</span>
        <p class="description">ุฅุฒุงูุฉ ุนุจุงุฑุฉ "ุงูุจุถุงุนุฉ ูุง ุชุฑุฏ"</p>
        <div class="before">ูุจู: "ุงูุจุถุงุนุฉ ุงููุจุงุนุฉ ูุง ุชุฑุฏ"</div>
        <div class="after">ุจุนุฏ: "ูุญู ููุนููู ุฅุฑุฌุงุน ุงูููุชุฌ ุฎูุงู 7 ุฃูุงู"</div>
    </div>
    
    <!-- ุงููุฒูุฏ ูู ุงูุชุญุณููุงุช -->
</div>
```

---

## ๐ API Endpoints

### 1. ุงูุชุญููู ุงููุงูู (ูุน ุฅุนุงุฏุฉ ุงููุชุงุจุฉ)
```http
POST /api/analyze
Content-Type: application/json

{
  "shop_name": "ูุชุฌุฑ ุงูุฃุฒูุงุก",
  "shop_specialization": "ููุงุจุณ ูุณุงุฆูุฉ",
  "policy_type": "ุณูุงุณุงุช ุงูุงุณุชุฑุฌุงุน ู ุงูุงุณุชุจุฏุงู",
  "policy_text": "ุงููุต ุงูุฃุตูู..."
}
```

**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "success": true,
  "message": "ุชู ุงูุชุญููู ุจูุฌุงุญ",
  "policy_match": {...},
  "compliance_report": {...},
  "improved_policy": {
    "improved_policy": "ุงููุต ุงููุญุณูู ุงููุงูู...",
    "improvements_made": [...],
    "estimated_new_compliance": 98,
    "key_additions": [...]
  }
}
```

### 2. ุฅุนุงุฏุฉ ุงููุชุงุจุฉ ููุท
```http
POST /api/regenerate-only
Content-Type: application/json

{
  "shop_name": "ูุชุฌุฑ ุงูุฃุฒูุงุก",
  "shop_specialization": "ููุงุจุณ ูุณุงุฆูุฉ",
  "policy_type": "ุณูุงุณุงุช ุงูุงุณุชุฑุฌุงุน ู ุงูุงุณุชุจุฏุงู",
  "original_policy": "ุงููุต ุงูุฃุตูู...",
  "compliance_report": {...}
}
```

---

## ๐ ุฌูุฏุฉ ุงูุฅุนุงุฏุฉ ุงููุชุงุจุฉ

### ูุนุงููุฑ ุงูุฌูุฏุฉ:

1. **ุงูุงูุชุซุงู ุงููุงูููู** โ
   - ุชุญููู 95%+ ุงูุชุซุงู
   - ุชุบุทูุฉ ุฌููุน ุงููุชุทูุจุงุช

2. **ุงููุถูุญ** โ
   - ูุบุฉ ุจุณูุทุฉ
   - ุชูุธูู ููุทูู
   - ุนูุงููู ูุงุถุญุฉ

3. **ุงูุดููููุฉ** โ
   - ูุง ูุนูููุงุช ููููุฏุฉ
   - ุฌููุน ุงูุงุณุชุซูุงุกุงุช
   - ุฃูุซูุฉ ุชูุถูุญูุฉ

4. **ุงูุชุฎุตูุต** โ
   - ููุงุณุจุฉ ูููุน ุงููุชุฌุฑ
   - ุงุณุชุซูุงุกุงุช ููุงุฆูุฉ
   - ุณูุงู ููุงุณุจ

---

## ๐ ุฃูุซูุฉ ุนูู ุงูุชุญุณููุงุช

### ูุซุงู 1: ุชุตุญูุญ ูุฎุงููุฉ ุญุฑุฌุฉ

**ูุจู:**
```
ูุง ููุจู ุงูุงุณุชุฑุฌุงุน ุจุนุฏ ูุชุญ ุงูุชุบููู
```
โ **ุงููุดููุฉ:** ุชุนููู ุฎุงุทุฆุ ุงูุงุณุชุซูุงุกุงุช ูุญุฏุฏุฉ ูุธุงูุงู

**ุจุนุฏ:**
```
ูุง ููุจู ุงุณุชุฑุฌุงุน ุงูููุชุฌุงุช ุงูุตุญูุฉ (ููุงุจุณ ุฏุงุฎููุฉุ 
ูุณุชุญุถุฑุงุช ุชุฌููู ููุชูุญุฉ) ูุฃุณุจุงุจ ุตุญูุฉุ ุฃูุง ุจุงูู 
ุงูููุชุฌุงุช ููููู ุงุณุชุฑุฌุงุนูุง ุญุชู ุจุนุฏ ูุชุญ ุงูุชุบููู 
ุฎูุงู 7 ุฃูุงู.
```
โ **ุงูุชุญุณูู:** ูุญุฏุฏุ ุฏูููุ ููุชุซู

---

### ูุซุงู 2: ุฅุถุงูุฉ ูุนูุงุฑ ููููุฏ

**ูุจู:**
```
[ูุง ููุฌุฏ ุฐูุฑ ูุชุฃุฎูุฑ ุงูุชูุตูู]
```
โ **ุงููุดููุฉ:** ูุนูุงุฑ ูุงูููู ููููุฏ (ุงููุงุฏุฉ 14)

**ุจุนุฏ:**
```
ูู ุญุงู ุชุฃุฎุฑ ุงูุชูุตูู ุฃูุซุฑ ูู 15 ูููุงู ูู ุชุงุฑูุฎ 
ุงูุทูุจ ุฃู ุงูููุนุฏ ุงููุญุฏุฏุ ูุญู ูู ุฅูุบุงุก ุงูุทูุจ 
ูุงุณุชุฑุฏุงุฏ ูุงูู ุงููุจูุบ ุงููุฏููุน ููุฑุงู ุฏูู ุฃู ุฎุตููุงุช.
```
โ **ุงูุชุญุณูู:** ูุนูุงุฑ ูุถุงูุ ููุชุซู ูููุงููู

---

### ูุซุงู 3: ุชุญุณูู ุงูุตูุงุบุฉ

**ูุจู:**
```
ูููู ูููุณุชููู ุฅุฑุฌุงุน ุงูุณูุนุฉ ุงููุดุชุฑุงุฉ
```
โ๏ธ **ุงููุดููุฉ:** ุตูุงุบุฉ ุบุงูุถุฉุ ุจุฏูู ุชูุงุตูู

**ุจุนุฏ:**
```
1. ุญู ุงูุฅุฑุฌุงุน: ูุญู ููุนููู ุฅุฑุฌุงุน ุงูููุชุฌ ุฎูุงู 7 ุฃูุงู

2. ุงูุดุฑูุท:
   - ุงูููุชุฌ ูู ุญุงูุชู ุงูุฃุตููุฉ
   - ูุฌูุฏ ุงููุงุชูุฑุฉ ุงูุฃุตููุฉ
   - ุนุฏู ุงูุงุณุชุฎุฏุงู

3. ุงูุฅุฌุฑุงุกุงุช:
   ุฃ. ุงูุชูุงุตู ูุน ุฎุฏูุฉ ุงูุนููุงุก
   ุจ. ุฅุนุงุฏุฉ ุงูููุชุฌ ุจุชุบูููู
   ุฌ. ุงุณุชุฑุฏุงุฏ ุงููุจูุบ ุฎูุงู 14 ููู
```
โ **ุงูุชุญุณูู:** ูุงุถุญุ ููุธูุ ุดุงูู

---

## โ๏ธ ุงูุฅุนุฏุงุฏุงุช

### ุชุฎุตูุต Prompt:

ูู `policy_generator.py`:
```python
# ูููู ุชุนุฏูู:
- ุงูุฃุณููุจ (ุฑุณูู/ูุฏูุฏ)
- ุงูุชูุตูู (ูุฎุชุตุฑ/ุดุงูู)
- ุงูุชูุธูู (ููุงุท/ููุฑุงุช)
- ุงูุฃูุซูุฉ (ูุซูุฑุฉ/ููููุฉ)
```

### ุชุญุฏูุฏ ุงูุญุฏ ุงูุฃุฏูู ููุงูุชุซุงู:

ูู `analyzer_service.py`:
```python
if compliance_report.overall_compliance_ratio < 95:
    # ุชูููุฐ Stage 4
```

ูููู ุชุบููุฑ `95` ุฅูู ูููุฉ ุฃุฎุฑู ุญุณุจ ุงูุญุงุฌุฉ.

---

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ Stage 4:

```python
# test_stage4.py
import pytest
from app.services.analyzer_service import AnalyzerService

@pytest.mark.asyncio
async def test_policy_regeneration():
    service = AnalyzerService()
    
    request = PolicyAnalysisRequest(
        shop_name="ูุชุฌุฑ ุงุฎุชุจุงุฑ",
        shop_specialization="ุฅููุชุฑูููุงุช",
        policy_type="ุณูุงุณุงุช ุงูุงุณุชุฑุฌุงุน ู ุงูุงุณุชุจุฏุงู",
        policy_text="ุงูุจุถุงุนุฉ ูุง ุชุฑุฏ ููุง ุชุณุชุจุฏู"
    )
    
    result = await service.analyze_policy(request)
    
    assert result.success
    assert result.improved_policy is not None
    assert result.improved_policy.estimated_new_compliance >= 95
```

---

## ๐ ุงูุฅุญุตุงุฆูุงุช

### ูุง ูุชู ุชุณุฌููู:

```python
# ูู logs/prompts/
20241214_153055_stage4_regenerate_ูุชุฌุฑ.txt

# ูู logs/responses/
20241214_153055_stage4_regenerate_ูุชุฌุฑ.json

# ุงูุจูุงูุงุช:
- ุทูู ุงูุณูุงุณุฉ ุงูุฃุตููุฉ
- ุทูู ุงูุณูุงุณุฉ ุงููุญุณููุฉ
- ูุณุจุฉ ุงูุงูุชุซุงู ูุจู/ุจุนุฏ
- ุนุฏุฏ ุงูุชุญุณููุงุช
- ุงูููุช ุงููุณุชุบุฑู
```

---

## ๐ก ูุตุงุฆุญ ููุงุณุชุฎุฏุงู

### ูููุทูุฑูู:

1. **ุฑุงุฌุน ุงูุณูุงุณุฉ ุงููุญุณููุฉ ุฏุงุฆูุงู**
   - ูุง ุชุณุชุฎุฏููุง ูุจุงุดุฑุฉ ุจุฏูู ูุฑุงุฌุนุฉ

2. **ุฎุตุตูุง ุญุณุจ ุงูุญุงุฌุฉ**
   - ูุฏ ุชุญุชุงุฌ ุชุนุฏููุงุช ุจุณูุทุฉ

3. **ุงุฌูุน feedback**
   - ูู ุงููุญุงููู ูุงููุชุงุฌุฑ

### ูููุชุงุฌุฑ:

1. **ุงุณุชุฎุฏููุง ููุงูุจ**
   - ููุณุช ูุณุฎุฉ ููุงุฆูุฉ

2. **ุฑุงุฌุนูุง ูุงููููุงู**
   - ุงุณุชุดุฑ ูุญุงูู ูุจู ุงููุดุฑ

3. **ุฎุตุตูุง ูุญุงูุชู**
   - ุฃุถู ุชูุงุตูู ุฎุงุตุฉ ุจู

---

## ๐ฏ ุงูุฎูุงุตุฉ

### ูุง ุชู ุฅุถุงูุชู:

- โ Stage 4: Policy Regeneration
- โ ุฅุนุงุฏุฉ ูุชุงุจุฉ ุฐููุฉ ููุณูุงุณุงุช
- โ ุชุทุจูู ุชููุงุฆู ููุงูุชุฑุงุญุงุช
- โ ุงูุชุซุงู 95%+
- โ ูุงุฌูุฉ ูุญุณููุฉ ูุนุฑุถ ุงููุชุงุฆุฌ
- โ API endpoint ุฌุฏูุฏ
- โ Logging ุดุงูู

### ุงููุชูุฌุฉ:

**ูู ูุต ุถุนูู (15% ุงูุชุซุงู) โ ุฅูู ุณูุงุณุฉ ุงุญุชุฑุงููุฉ (98% ุงูุชุซุงู) โจ**

---

**ุงููุฑุญูุฉ ุงูุฑุงุจุนุฉ ุฌุงูุฒุฉ ููุชูุงููุฉ! ๐**
